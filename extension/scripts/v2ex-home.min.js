"use strict";async function P(n,t){let o=await fetch(n,t),e=o.headers.get("X-Rate-Limit-Limit"),a=o.headers.get("X-Rate-Limit-Reset"),c=o.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",p=>{let i={pat:p["api"]?.pat,limit:e?Number(e):void 0,reset:a?Number(a):void 0,remaining:c?Number(c):void 0};chrome.storage.sync.set({["api"]:i})}),o.json()}function g(n,t){return P(`${"https://www.v2ex.com/api/v2"}/topics/${n}`,{method:"GET",headers:{Authorization:`Bearer ${t}`}})}var _=$('#Top .tools > a[href^="/member"]').text(),E=$("#Main > .box:nth-child(1) > .header > small > a").text(),y=$("#Main #Tabs ~ .cell.item"),R=$("#Main .box:has(.topic_content)"),T=$('#Main .box:has(.cell[id^="r_"])'),b=T.find('.cell[id^="r_"]'),L=b.find("> table > tbody > tr"),D=L.map((n,t)=>{let o=b[n].id,e=$(t).find("> td:nth-child(3)"),a=e.find("> strong > a"),c=a.text(),p=a.prop("href"),i=e.find("> .reply_content").text(),d=Number(e.find("span.small").text()),r=e.find("span.no").text(),s=Array.from(i.matchAll(/@([a-zA-Z0-9]+)/g)),l=s.length>0?s.map(([,m])=>m):void 0,f=Array.from(i.matchAll(/#(\d+)/g)),u=f.length>0?f.map(([,m])=>m):void 0;return{id:o,memberName:c,memberLink:p,content:i,likes:d,floor:r,index:n,refMemberNames:l,refFloors:u}}).get();function v(n){let{root:t,title:o,onOpen:e,onClose:a,onMount:c}=n,p=$('<div class="v2p-model-mask">'),i=$('<div class="v2p-model-content">'),d=$(`
    <div class="v2p-model-main">
      <div class="v2p-model-header">
        <span>${o??""}</span>
        <button class="v2p-model-close-btn normal button">\u5173\u95ED<kbd>Esc</kbd></button>
      </div>
    </div>
    `).append(i),r=p.append(d).hide(),s={$modelMask:p,$modelMain:d,$modelContainer:r,$modelContent:i},l=!1,f=h=>{$(h.target).closest(i).length===0&&m()},u=h=>{h.key==="Escape"&&m()},m=()=>{$(document).off("click",f),$(document).off("keydown",u),l=!1,r.fadeOut("fast"),document.body.classList.remove("v2p-modal-open"),a?.(s)},A=()=>{setTimeout(()=>{l||($(document).on("click",f),$(document).on("keydown",u),l=!0)},0),r.fadeIn("fast"),document.body.classList.add("v2p-modal-open"),e?.(s)};return r.find(".v2p-model-close-btn").on("click",m),c?.(s),t&&t.append(r),{...s,open:A,close:m}}function x(){chrome.storage.sync.get("api",n=>{let t=n["api"]?.pat;if(!t)return;let o=v({root:$("body"),title:"\u8BDD\u9898\u9884\u89C8",onClose:({$modelContent:e})=>{e.empty()}});y.each((e,a)=>{let c=$(a);$('<button class="v2p-topic-preview-btn">\u9884\u89C8</button>').on("click",()=>{let d=c.find(".topic-link").attr("href")?.match(/\/(\d+)#/)?.at(1);d&&(async()=>{try{o.open();let s=(await g(d,t)).result,l=$(`
                <div class="v2p-topic-preview">
                  <div class="v2p-topic-preview__title">${s.title}</div>
                  <div class="v2p-topic-preview__content">${s.content_rendered}</div>
                </div>
                `);o.$modelContent.append(l)}catch(r){console.error(r)}})()}).appendTo(c.find(".item_title"))})})}$("#Main .tab").addClass("v2p-hover-btn"),$('#Main .topic-link, .item_hot_topic_title > a, .item_node, a[href="/write"]').prop("target","_blank").prop("rel","noopener noreferrer");x();
