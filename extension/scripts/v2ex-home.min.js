"use strict";var B=60*60*1e3;var b=`
<svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
  viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
  <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite"
      begin="0.1"/>    
  </circle>
  <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.2"/>       
  </circle>
  <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.3"/>     
  </circle>
</svg>
`;async function P(r,o){let e=await fetch(r,o),t=e.headers.get("X-Rate-Limit-Limit"),n=e.headers.get("X-Rate-Limit-Reset"),i=e.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",c=>{let s={pat:c["api"]?.pat,limit:t?Number(t):void 0,reset:n?Number(n):void 0,remaining:i?Number(i):void 0};chrome.storage.sync.set({["api"]:s})}),e.json()}function k(r,o,e){return P(`${"https://www.v2ex.com/api/v2"}/topics/${r}`,{method:"GET",headers:{Authorization:`Bearer ${o}`},...e})}var H=$('#Top .tools > a[href^="/member"]').text(),J=$('#Main > .box > .header > small > a[href^="/member"]').text(),A=$("#Main #Tabs ~ .cell.item"),O=$("#Main .box:has(.topic_content)"),T=$('#Main .box:has(.cell[id^="r_"])'),M=T.find('.cell[id^="r_"]'),R=M.find("> table > tbody > tr"),Q=R.map((r,o)=>{let e=M[r].id,t=$(o).find("> td:nth-child(3)"),n=t.find("> strong > a"),i=n.text(),c=n.prop("href"),s=t.find("> .reply_content").text(),u=Number(t.find("span.small").text()),h=t.find("span.no").text(),l=Array.from(s.matchAll(/@([a-zA-Z0-9]+)/g)),a=l.length>0?l.map(([,m])=>m):void 0,p=Array.from(s.matchAll(/#(\d+)/g)),d=p.length>0?p.map(([,m])=>m):void 0;return{id:e,memberName:i,memberLink:c,content:s,likes:u,floor:h,index:r,refMemberNames:a,refFloors:d}}).get();function w(r){let{children:o,className:e="",type:t="button"}=r;return $(`<button class="normal button ${e}" type="${t}">${o}</button>`)}function C(r){let{root:o,title:e,onOpen:t,onClose:n,onMount:i}=r,c=$('<div class="v2p-model-mask">'),s=$('<div class="v2p-model-content">'),u=w({children:"\u5173\u95ED<kbd>Esc</kbd>",className:"v2p-model-close-btn"}),h=$(`<div class="v2p-model-title">${e??""}</div>`),l=$('<div class="v2p-model-actions">').append(u),a=$('<div class="v2p-model-header">').append(h,l),p=$('<div class="v2p-model-main">').append(a,s),d=c.append(p).hide(),m={$mask:c,$main:p,$container:d,$title:h,$actions:l,$content:s},f=!1,x=v=>{$(v.target).closest(p).length===0&&g()},y=v=>{v.key==="Escape"&&g()},g=()=>{$(document).off("click",x),$(document).off("keydown",y),f=!1,d.fadeOut("fast"),document.body.classList.remove("v2p-modal-open"),n?.(m)},L=()=>{setTimeout(()=>{f||($(document).on("click",x),$(document).on("keydown",y),f=!0)},0),d.fadeIn("fast"),document.body.classList.add("v2p-modal-open"),t?.(m)};return u.on("click",g),i?.(m),o&&o.append(d),{...m,open:L,close:g}}function I(){chrome.storage.sync.get("api",r=>{let o=r["api"]?.pat;if(!o)return;let e=null,t=w({children:'<a target="_blank">\u8FDB\u5165\u4E3B\u9898</a>',className:"special"}),n=C({root:$("body"),onMount:({$actions:i})=>{i.prepend(t)},onClose:({$title:i,$content:c})=>{i.empty(),c.empty(),e?.abort()}});A.each((i,c)=>{let s=$(c);$('<button class="v2p-topic-preview-btn">\u9884\u89C8</button>').on("click",()=>{let l=s.find(".topic-link").attr("href")?.match(/\/(\d+)#/)?.at(1);l&&(async()=>{try{e=new AbortController,n.open(),t.hide(),n.$title.empty().text("..."),n.$content.empty().append(`
                <div class="v2p-model-loading">
                  <div class="v2p-icon-loading">${b}</div>
                </div>
                `);let{result:a}=await k(l,o,{signal:e.signal}),p=$(`
                <div class="v2p-topic-preview">
                  <div>${a.content_rendered}</div>
                </div>
                `);t.show().find("> a").prop("href",a.url),n.$title.empty().text(a.title),n.$content.empty().append(p)}catch(a){console.error(a)}})()}).appendTo(s.find(".item_title"))})})}$("#Main .tab").addClass("v2p-hover-btn"),$('#Main .topic-link, .item_hot_topic_title > a, .item_node, a[href="/write"]').prop("target","_blank").prop("rel","noopener noreferrer");I();
