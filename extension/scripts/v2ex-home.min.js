"use strict";var k=60*60*1e3;async function T(n,o){let e=await fetch(n,o),t=e.headers.get("X-Rate-Limit-Limit"),r=e.headers.get("X-Rate-Limit-Reset"),s=e.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",m=>{let i={pat:m["api"]?.pat,limit:t?Number(t):void 0,reset:r?Number(r):void 0,remaining:s?Number(s):void 0};chrome.storage.sync.set({["api"]:i})}),e.json()}function y(n,o){return T(`${"https://www.v2ex.com/api/v2"}/topics/${n}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}})}var R=$('#Top .tools > a[href^="/member"]').text(),D=$("#Main > .box:nth-child(1) > .header > small > a").text(),b=$("#Main #Tabs ~ .cell.item"),J=$("#Main .box:has(.topic_content)"),L=$('#Main .box:has(.cell[id^="r_"])'),v=L.find('.cell[id^="r_"]'),M=v.find("> table > tbody > tr"),Q=M.map((n,o)=>{let e=v[n].id,t=$(o).find("> td:nth-child(3)"),r=t.find("> strong > a"),s=r.text(),m=r.prop("href"),i=t.find("> .reply_content").text(),p=Number(t.find("span.small").text()),a=t.find("span.no").text(),c=Array.from(i.matchAll(/@([a-zA-Z0-9]+)/g)),d=c.length>0?c.map(([,u])=>u):void 0,l=Array.from(i.matchAll(/#(\d+)/g)),f=l.length>0?l.map(([,u])=>u):void 0;return{id:e,memberName:s,memberLink:m,content:i,likes:p,floor:a,index:n,refMemberNames:d,refFloors:f}}).get();function N(n){let{children:o,className:e="",type:t="button"}=n;return $(`<button class="normal button ${e}" type="${t}">${o}</button>`)}function x(n){let{root:o,title:e,onOpen:t,onClose:r,onMount:s}=n,m=$('<div class="v2p-model-mask">'),i=$('<div class="v2p-model-content">'),p=N({children:"\u5173\u95ED<kbd>Esc</kbd>",className:"v2p-model-close-btn"}),a=$(`
    <div class="v2p-model-main">
      <div class="v2p-model-header">
        ${e?`<span>${e}</span>`:""}
        ${p.get(0).outerHTML}
      </div>
    </div>
    `).append(i),c=m.append(a).hide(),d={$modelMask:m,$modelMain:a,$modelContainer:c,$modelContent:i},l=!1,f=g=>{$(g.target).closest(i).length===0&&h()},u=g=>{g.key==="Escape"&&h()},h=()=>{$(document).off("click",f),$(document).off("keydown",u),l=!1,c.fadeOut("fast"),document.body.classList.remove("v2p-modal-open"),r?.(d)},I=()=>{setTimeout(()=>{l||($(document).on("click",f),$(document).on("keydown",u),l=!0)},0),c.fadeIn("fast"),document.body.classList.add("v2p-modal-open"),t?.(d)};return p.on("click",h),s?.(d),o&&o.append(c),{...d,open:I,close:h}}function A(){chrome.storage.sync.get("api",n=>{let o=n["api"]?.pat;if(!o)return;let e=x({root:$("body"),title:"\u8BDD\u9898\u9884\u89C8",onClose:({$modelContent:t})=>{t.empty()}});b.each((t,r)=>{let s=$(r);$('<button class="v2p-topic-preview-btn">\u9884\u89C8</button>').on("click",()=>{let p=s.find(".topic-link").attr("href")?.match(/\/(\d+)#/)?.at(1);p&&(async()=>{try{e.open();let{result:a}=await y(p,o),c=$(`
                <div class="v2p-topic-preview">
                  <div class="v2p-topic-preview__title">${a.title}</div>
                  <div class="v2p-topic-preview__content">${a.content_rendered}</div>
                </div>
                `);e.$modelContent.append(c)}catch(a){console.error(a)}})()}).appendTo(s.find(".item_title"))})})}$("#Main .tab").addClass("v2p-hover-btn"),$('#Main .topic-link, .item_hot_topic_title > a, .item_node, a[href="/write"]').prop("target","_blank").prop("rel","noopener noreferrer");A();
