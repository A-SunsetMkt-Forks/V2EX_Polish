"use strict";async function L(n,t){let o=await fetch(n,t),e=o.headers.get("X-Rate-Limit-Limit"),a=o.headers.get("X-Rate-Limit-Reset"),c=o.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",m=>{let i={pat:m["api"]?.pat,limit:e?Number(e):void 0,reset:a?Number(a):void 0,remaining:c?Number(c):void 0};chrome.storage.sync.set({["api"]:i})}),o.json()}function g(n,t){return L(`${"https://www.v2ex.com/api/v2"}/topics/${n}`,{method:"GET",headers:{Authorization:`Bearer ${t}`}})}var R=$('#Top .tools > a[href^="/member"]').text(),N=$("#Main > .box:nth-child(1) > .header > small > a").text(),y=$("#Main #Tabs ~ .cell.item"),D=$("#Main .box:has(.topic_content)"),P=$('#Main .box:has(.cell[id^="r_"])'),v=P.find('.cell[id^="r_"]'),M=v.find("> table > tbody > tr"),E=M.map((n,t)=>{let o=v[n].id,e=$(t).find("> td:nth-child(3)"),a=e.find("> strong > a"),c=a.text(),m=a.prop("href"),i=e.find("> .reply_content").text(),f=Number(e.find("span.small").text()),s=e.find("span.no").text(),r=Array.from(i.matchAll(/@([a-zA-Z0-9]+)/g)),p=r.length>0?r.map(([,l])=>l):void 0,d=Array.from(i.matchAll(/#(\d+)/g)),u=d.length>0?d.map(([,l])=>l):void 0;return{id:o,memberName:c,memberLink:m,content:i,likes:f,floor:s,index:n,refMemberNames:p,refFloors:u}}).get();function b(n){let{root:t,title:o,onOpen:e,onClose:a,onMount:c}=n,m=$('<div class="v2p-model-mask">'),i=$('<div class="v2p-model-content">'),f=$(`
    <div class="v2p-model-main">
      <div class="v2p-model-header">
        <span>${o??""}</span>
        <button class="v2p-model-close-btn normal button">\u5173\u95ED<kbd>Esc</kbd></button>
      </div>
    </div>
    `).append(i),s=m.append(f).hide(),r={$modelMask:m,$modelMain:f,$modelContainer:s,$modelContent:i},p=!1,d=h=>{$(h.target).closest(i).length===0&&l()},u=h=>{h.key==="Escape"&&l()},l=()=>{$(document).off("click",d),$(document).off("keydown",u),p=!1,s.fadeOut("fast"),document.body.classList.remove("v2p-modal-open"),a?.(r)},I=()=>{p||($(document).on("click",d),$(document).on("keydown",u),p=!0),s.fadeIn("fast"),document.body.classList.add("v2p-modal-open"),e?.(r)};return s.find(".v2p-model-close-btn").on("click",l),c?.(r),t&&t.append(s),{...r,open:I}}function x(){chrome.storage.sync.get("api",n=>{let t=n["api"]?.pat;if(!t)return;let o=b({root:$("body"),title:"\u8BDD\u9898\u9884\u89C8",onClose:({$modelContent:e})=>{e.empty()}});y.each((e,a)=>{let c=$(a);$('<button class="v2p-topic-preview-btn">\u9884\u89C8</button>').on("click",m=>{let s=c.find(".topic-link").attr("href")?.match(/\/(\d+)#/)?.at(1);s&&(async()=>{try{m.stopPropagation(),o.open();let p=(await g(s,t)).result,d=$(`
                <div class="v2p-topic-preview">
                  <div class="v2p-topic-preview__title">${p.title}</div>
                  <div class="v2p-topic-preview__content">${p.content_rendered}</div>
                </div>
                `);o.$modelContent.append(d)}catch(r){console.error(r)}})()}).prependTo(c.find(".topic_info"))})})}$("#Main .tab").addClass("v2p-hover-btn"),$('#Main .topic-link, .item_hot_topic_title > a, .item_node, a[href="/write"]').prop("target","_blank").prop("rel","noopener noreferrer");x();
