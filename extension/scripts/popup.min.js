"use strict";var w=60*60*1e3;var z=$('#Top .tools > a[href^="/member"]').text(),F=$('#Main > .box > .header > small > a[href^="/member"]').text(),J=$("#Main #Tabs ~ .cell.item"),O=$("#Main .box:has(.topic_content)"),D=$('#Main .box:has(.cell[id^="r_"])'),x=D.find('.cell[id^="r_"]'),N=x.find("> table > tbody > tr"),Q=N.map((n,a)=>{let e=x[n].id,o=$(a).find("> td:nth-child(3)"),r=o.find("> strong > a"),c=r.text(),m=r.prop("href"),p=o.find("> .reply_content").text(),g=Number(o.find("span.small").text()),t=o.find("span.no").text(),s=Array.from(p.matchAll(/@([a-zA-Z0-9]+)/g)),d=s.length>0?s.map(([,u])=>u):void 0,i=Array.from(p.matchAll(/#(\d+)/g)),f=i.length>0?i.map(([,u])=>u):void 0;return{id:e,memberName:c,memberLink:m,content:p,likes:g,floor:t,index:n,refMemberNames:d,refFloors:f}}).get();function y(n){let{children:a,className:e="",type:o="button"}=n;return $(`<button class="normal button ${e}" type="${o}">${a}</button>`)}var I=`
<svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
  viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
  <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite"
      begin="0.1"/>    
  </circle>
  <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.2"/>       
  </circle>
  <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.3"/>     
  </circle>
</svg>
`;async function k(n,a){let e=await fetch(n,a),o=e.headers.get("X-Rate-Limit-Limit"),r=e.headers.get("X-Rate-Limit-Reset"),c=e.headers.get("X-Rate-Limit-Remaining"),m={limit:o?Number(o):void 0,reset:r?Number(r):void 0,remaining:c?Number(c):void 0};return await chrome.storage.sync.set({["legacy-api"]:m}),e.json()}function S(n){return k(`${"https://www.v2ex.com/api"}/topics/latest.json`,n)}function A(n){return k(`${"https://www.v2ex.com/api"}/topics/hot.json`,n)}async function R(n,a){let e=await fetch(n,a),o=e.headers.get("X-Rate-Limit-Limit"),r=e.headers.get("X-Rate-Limit-Reset"),c=e.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",m=>{let p={pat:m["api"]?.pat,limit:o?Number(o):void 0,reset:r?Number(r):void 0,remaining:c?Number(c):void 0};chrome.storage.sync.set({["api"]:p})}),e.json()}function L(n,a=1){return R(`${"https://www.v2ex.com/api/v2"}/notifications?p=${a}`,{method:"GET",headers:{Authorization:`Bearer ${n}`}})}function C(n,a=!1){let e=new Date(n*1e3),o=e.getFullYear().toString(),r=(e.getMonth()+1).toString().padStart(2,"0"),c=e.getDate().toString().padStart(2,"0"),m=`${o}-${r}-${c}`;if(a){let p=e.getHours().toString().padStart(2,"0"),g=e.getMinutes().toString().padStart(2,"0"),t=e.getSeconds().toString().padStart(2,"0");return`${m} ${p}:${g}:${t}`}return m}var b="-",M=`
<div class="tab-loading">
  <span class="loading">
    ${I}
  </span>
</div>
`,P='<div class="fetch-error">\u65E0\u6CD5\u83B7\u53D6\u5230\u5217\u8868\u6570\u636E\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002</div>';function H(){let n=$("#pat");n.on("change",a=>{a.target.value?n.addClass("has-value"):n.removeClass("has-value")}),chrome.storage.sync.get("api",a=>{let e=a["api"];e&&(e.pat&&n.val(e.pat).addClass("has-value"),$("#limit").val(e.limit??b),$("#reset").val(e.reset?C(e.reset,!0):b),$("#remaining").val(e.remaining??b))}),$("#settings-form").on("submit",function(a){console.log(123),a.preventDefault();let e=n.val();typeof e=="string"&&chrome.storage.sync.set({["api"]:{pat:e}},()=>{let o=$(".submit-btn"),r=o.text();o.text("\u4FDD\u5B58\u6210\u529F").prop("disabled",!0),setTimeout(()=>{o.text(r).prop("disabled",!1)},1500)})}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function B(){let n=t=>t.map(s=>`
          <li class="topic-item">
            <a href="${s.url}" target="_blank">
              <span class="title">${s.title}</span>
              <span class="content">${s.content.replace(/<[^>]*>/g,"")}</span>
            </a>
          </li>
          `).join(""),a=()=>$(".tabs > li.active"),e=t=>typeof t=="string"&&(t==="tab-hot"||t==="tab-latest"||t==="tab-message"||t==="tab-setting"),o={["tab-hot"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab-latest"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab-message"]:{data:void 0,lastFetchTime:void 0},["tab-setting"]:{}},r=window.localStorage.getItem("v2p_popup"),c=r?JSON.parse(r):null,m=async({tabId:t})=>{let s,d=0,i=$(`#${t}`);if(t==="tab-hot"||t==="tab-latest")if(i.find(".list").length>0)d=o[t].lastScrollTop??0;else{let u=async()=>{i.html(M);try{if(t==="tab-hot"){let l=await A();return o[t].data=l,o[t].lastFetchTime=Date.now(),l}else{let l=await S();return o[t].data=l,o[t].lastFetchTime=Date.now(),l}}catch{i.html(P)}};if(c){let{data:l,lastFetchTime:h,lastScrollTop:v}=c[t];v&&(d=v),!l||!h||Date.now()-h>w?s=await u():s=l}else s=await u();if(s){let l=$('<ul class="list">').append(n(s));i.empty().append(l)}}t==="tab-message"&&chrome.storage.sync.get("api",f=>{let u=f["api"];if(u?.pat){if(i.find(".list").length>0)return;i.html(M),L(u.pat).then(({result:h})=>{if(h.length>0){let v=$('<ul class="list">').append(h.map(T=>`
                    <li class="notice-item">
                      <div class="notice">
                        ${T.text}
                      </div>
                      ${T.payload?`<div class="payload">${T.payload}</div>`:""}
                    </li>
                    `).join(""));i.empty().append(v)}else i.empty().append('<div class="tip">\u6682\u65E0\u6D88\u606F</div>')}).catch(()=>{i.html(P)})}else{let l=y({children:"\u53BB\u8BBE\u7F6E"}).on("click",()=>{g({tabId:"tab-setting"})}),h=$('<div class="tip"><p>\u9700\u6C42\u8BBE\u7F6E\u60A8\u7684\u4E2A\u4EBA\u8BBF\u95EE\u4EE4\u724C\uFF08PAT\uFF09\u540E\u624D\u80FD\u8BF7\u6C42\u83B7\u53D6\u6D88\u606F\u6570\u636E</p></div>').append(l);i.empty().append(h)}}),setTimeout(()=>{i.scrollTop(d)},0)},p=t=>{let s=t.data("target");if(e(s)){let d=a(),i=d.data("target");if(e(i)){let f=$(`#${i}`);o[i].lastScrollTop=f.scrollTop(),d.removeClass("active"),f.removeClass("active")}t.addClass("active"),$(`#${s}`).addClass("active"),m({tabId:s})}},g=({tabId:t,tabEle:s}={})=>{p(t?$(`.tabs > li[data-target="${t}"]`):s||$(".tabs > li:first-child"))};$(".tabs > li").on("click",t=>{g({tabEle:$(t.currentTarget)})}),H(),g({tabId:c?.lastActiveTab}),window.addEventListener("unload",()=>{let t=a().data("target");if(e(t)){let d=$(`#${t}`).scrollTop(),i={lastActiveTab:t,["tab-hot"]:{data:o["tab-hot"].data,lastFetchTime:o["tab-hot"].lastFetchTime,lastScrollTop:t==="tab-hot"?d:void 0},["tab-latest"]:{data:o["tab-latest"].data,lastFetchTime:o["tab-latest"].lastFetchTime,lastScrollTop:t==="tab-latest"?d:void 0},["tab-setting"]:{lastScrollTop:t==="tab-setting"?d:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(i))}})}window.addEventListener("load",()=>{B()});
