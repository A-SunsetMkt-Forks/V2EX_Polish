"use strict";var v=60*60*1e3;var b=`
<svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
  viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
  <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite"
      begin="0.1"/>    
  </circle>
  <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.2"/>       
  </circle>
  <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.3"/>     
  </circle>
</svg>
`;async function x(a,e){let n=await fetch(a,e),i=n.headers.get("X-Rate-Limit-Limit"),p=n.headers.get("X-Rate-Limit-Reset"),l=n.headers.get("X-Rate-Limit-Remaining"),d={limit:i?Number(i):void 0,reset:p?Number(p):void 0,remaining:l?Number(l):void 0};return await chrome.storage.sync.set({["legacy-api"]:d}),n.json()}function I(a){return x(`${"https://www.v2ex.com/api"}/topics/latest.json`,a)}function S(a){return x(`${"https://www.v2ex.com/api"}/topics/hot.json`,a)}function y(a,e=!1){let n=new Date(a*1e3),i=n.getFullYear().toString(),p=(n.getMonth()+1).toString().padStart(2,"0"),l=n.getDate().toString().padStart(2,"0"),d=`${i}-${p}-${l}`;if(e){let u=n.getHours().toString().padStart(2,"0"),m=n.getMinutes().toString().padStart(2,"0"),t=n.getSeconds().toString().padStart(2,"0");return`${d} ${u}:${m}:${t}`}return d}var f="-";function k(){chrome.storage.sync.get("api",a=>{let e=a["api"];e&&(e.pat&&$("#pat").addClass("has-value").val(e.pat),$("#limit").val(e.limit??f),$("#reset").val(e.reset?y(e.reset,!0):f),$("#remaining").val(e.remaining??f))}),$("#settings-form").on("submit",function(a){a.preventDefault();let e=$("#pat").val();typeof e=="string"&&chrome.storage.sync.set({["api"]:{pat:e}},()=>{console.log("\u4FDD\u5B58\u6210\u529F")})}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function P(){let a=t=>t.map(o=>`
          <li class="topic-item">
            <a href="${o.url}" target="_blank">
              <span class="title">${o.title}</span>
              <span class="content">${o.content.replace(/<[^>]*>/g,"")}</span>
            </a>
          </li>
          `).join(""),e=()=>$(".tabs > li.active"),n=t=>typeof t=="string"&&(t==="tab1"||t==="tab2"||t==="tab3"),i={["tab1"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab2"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab3"]:{}},p=window.localStorage.getItem("v2p_popup"),l=p?JSON.parse(p):null,d=async({tabId:t})=>{let o,r=0,s=$(`#${t}`);if(t==="tab1"||t==="tab2")if(s.find(".topics").length>0)r=i[t].lastScrollTop??0;else{let A=`
        <div class="tab-loading">
          <span class="loading">
            ${b}
          </span>
        </div>
        `,h=async()=>{s.html(A);try{if(t==="tab1"){let c=await S();return i[t].data=c,i[t].lastFetchTime=Date.now(),c}else{let c=await I();return i[t].data=c,i[t].lastFetchTime=Date.now(),c}}catch{s.html('<div class="fetch-error">\u65E0\u6CD5\u83B7\u53D6\u5230\u5217\u8868\u6570\u636E\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002</div>')}};if(l){let{data:c,lastFetchTime:T,lastScrollTop:w}=l[t];w&&(r=w),!c||!T||Date.now()-T>v?o=await h():o=c}else o=await h();if(o){let c=$('<ul class="topics">').append(a(o));s.empty().append(c)}}setTimeout(()=>{s.scrollTop(r)},0)},u=t=>{let o=t.data("target");if(n(o)){let r=e(),s=r.data("target");if(n(s)){let g=$(`#${s}`);i[s].lastScrollTop=g.scrollTop(),r.removeClass("active"),g.removeClass("active")}t.addClass("active"),$(`#${o}`).addClass("active"),d({tabId:o})}},m=({tabId:t,tabEle:o}={})=>{u(t?$(`.tabs > li[data-target="${t}"]`):o||$(".tabs > li:first-child"))};$(".tabs > li").on("click",t=>{m({tabEle:$(t.currentTarget)})}),k(),m({tabId:l?.lastActiveTab}),window.addEventListener("unload",()=>{let t=e().data("target");if(n(t)){let r=$(`#${t}`).scrollTop(),s={lastActiveTab:t,["tab1"]:{data:i["tab1"].data,lastFetchTime:i["tab1"].lastFetchTime,lastScrollTop:t==="tab1"?r:void 0},["tab2"]:{data:i["tab2"].data,lastFetchTime:i["tab2"].lastFetchTime,lastScrollTop:t==="tab2"?r:void 0},["tab3"]:{lastScrollTop:t==="tab3"?r:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(s))}})}window.addEventListener("load",()=>{P()});
