"use strict";async function g(i,s){let o=await fetch(i,s),n=o.headers.get("X-Rate-Limit-Limit"),a=o.headers.get("X-Rate-Limit-Reset"),c=o.headers.get("X-Rate-Limit-Remaining"),t={limit:n?Number(n):void 0,reset:a?Number(a):void 0,remaining:c?Number(c):void 0};return await chrome.storage.sync.set({["legacy-api"]:t}),o.json()}function p(i){return g(`${"https://www.v2ex.com/api"}/topics/latest.json`,i)}function u(i){return g(`${"https://www.v2ex.com/api"}/topics/hot.json`,i)}function T(i){let s=new Date(i*1e3),o=s.getFullYear().toString(),n=(s.getMonth()+1).toString().padStart(2,"0"),a=s.getDate().toString().padStart(2,"0");return`${o}-${n}-${a}`}function S(){let i=document.querySelector("#save");chrome.storage.sync.get("api",o=>{let n=document.querySelector("#pat"),a=document.querySelector("#limit"),c=document.querySelector("#reset"),t=document.querySelector("#remaining"),e=o["api"];n instanceof HTMLInputElement&&a instanceof HTMLInputElement&&c instanceof HTMLInputElement&&t instanceof HTMLInputElement&&e&&(n.value=e.pat??"",a.value=String(e.limit),c.value=e.reset?T(e.reset):"",t.value=String(e.remaining))}),chrome.storage.sync.get("legacy-api",o=>{let n=document.querySelector("#limitv1"),a=document.querySelector("#resetv1"),c=document.querySelector("#remainingv1"),t=o["legacy-api"];n instanceof HTMLInputElement&&a instanceof HTMLInputElement&&c instanceof HTMLInputElement&&t&&(n.value=String(t.limit),a.value=String(t.reset),c.value=String(t.remaining))});async function s(){let o=document.querySelector("#pat");if(o instanceof HTMLInputElement&&o.value.length>0){let n={pat:o.value};await chrome.storage.sync.set({["api"]:n})}}i instanceof HTMLButtonElement&&i.addEventListener("click",()=>{s()})}async function h(){let i=t=>typeof t=="string",s=({tabId:t,tabEle:e,scrollTop:r=0}={})=>{let l=m=>{let d=m.data("target");if(i(d)){let f=$(`#${d}`);m.addClass("active").siblings().removeClass("active"),f.addClass("active").siblings().removeClass("active"),setTimeout(()=>{window.scrollTo(0,r)},0)}};l(t?$(`.tabs > li[data-target="${t}"]`):e||$(".tabs > li:first-child"))},o=t=>t.map(e=>`
          <li class="topic-item">
            <a href="${e.url}" target="_blank">
              <span class="title">${e.title}</span>
              <span class="content">${e.content}</span>
            </a>
          </li>
          `).join(""),n=[],a=[],c=window.localStorage.getItem("v2p_popup");if(c){let t=JSON.parse(c);n=t["tab1"].data,a=t["tab2"].data;let{lastScrollTop:e,lastFetchTime:r}=t[t.lastActiveTab];if(Date.now()-r>1e3*60*5){let[l,m]=await Promise.all([u(),p()]);n=l,a=m}s({tabId:t.lastActiveTab,scrollTop:e})}else{s();let[t,e]=await Promise.all([u(),p()]);n=t,a=e}$(".topics.hot").append(o(n)),$(".topics.latest").append(o(a)),$(".tabs > li").on("click",t=>{s({tabEle:$(t.currentTarget)})}),window.addEventListener("unload",()=>{let t=$(".tabs > li.active").data("target");if(i(t)){let e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,r={lastActiveTab:t,["tab1"]:{data:n,lastFetchTime:Date.now(),lastScrollTop:t==="tab1"?e:void 0},["tab2"]:{data:a,lastFetchTime:Date.now(),lastScrollTop:t==="tab2"?e:void 0},["tab3"]:{data:[],lastFetchTime:Date.now(),lastScrollTop:t==="tab3"?e:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(r))}})}window.addEventListener("load",()=>{S(),h()});
