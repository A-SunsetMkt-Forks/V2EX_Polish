"use strict";async function S(i,r){let n=await fetch(i,r),a=n.headers.get("X-Rate-Limit-Limit"),o=n.headers.get("X-Rate-Limit-Reset"),c=n.headers.get("X-Rate-Limit-Remaining"),s={limit:a?Number(a):void 0,reset:o?Number(o):void 0,remaining:c?Number(c):void 0};return await chrome.storage.sync.set({["legacy-api"]:s}),n.json()}function L(i){return S(`${"https://www.v2ex.com/api"}/topics/latest.json`,i)}function b(i){return S(`${"https://www.v2ex.com/api"}/topics/hot.json`,i)}function w(i){let r=new Date(i*1e3),n=r.getFullYear().toString(),a=(r.getMonth()+1).toString().padStart(2,"0"),o=r.getDate().toString().padStart(2,"0");return`${n}-${a}-${o}`}function A(){let i=document.querySelector("#save");chrome.storage.sync.get("api",n=>{let a=document.querySelector("#pat"),o=document.querySelector("#limit"),c=document.querySelector("#reset"),s=document.querySelector("#remaining"),l=n["api"];a instanceof HTMLInputElement&&o instanceof HTMLInputElement&&c instanceof HTMLInputElement&&s instanceof HTMLInputElement&&l&&(a.value=l.pat??"",o.value=String(l.limit),c.value=l.reset?w(l.reset):"",s.value=String(l.remaining))}),chrome.storage.sync.get("legacy-api",n=>{let a=document.querySelector("#limitv1"),o=document.querySelector("#resetv1"),c=document.querySelector("#remainingv1"),s=n["legacy-api"];a instanceof HTMLInputElement&&o instanceof HTMLInputElement&&c instanceof HTMLInputElement&&s&&(a.value=String(s.limit),o.value=String(s.reset),c.value=String(s.remaining))});async function r(){let n=document.querySelector("#pat");if(n instanceof HTMLInputElement&&n.value.length>0){let a={pat:n.value};await chrome.storage.sync.set({["api"]:a})}}i instanceof HTMLButtonElement&&i.addEventListener("click",()=>{r()}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function P(){let i=t=>t.map(e=>`
          <li class="topic-item">
            <a href="${e.url}" target="_blank">
              <span class="title">${e.title}</span>
              <span class="content">${e.content}</span>
            </a>
          </li>
          `).join(""),r=t=>typeof t=="string"&&(t==="tab1"||t==="tab2"||t==="tab3"),n,a,o,c,s=window.localStorage.getItem("v2p_popup"),l=s?JSON.parse(s):null,y=async({tabId:t})=>{let e=[],p=0,g=$(`#${t}`);if(t==="tab1"||t==="tab2"){let T=async()=>{if(g.html("Loading..."),t==="tab1"){let m=await b();return n=m,o=Date.now(),m}else if(t==="tab2"){let m=await L();return a=m,c=Date.now(),m}return[]};if(l){let{data:m,lastFetchTime:f,lastScrollTop:I}=l[t];I&&(p=I),!m||!f||Date.now()-f>1e3*60*10?e=await T():e=m}else e=await T();let h=$('<ul class="topics">').append(i(e));g.empty().append(h)}setTimeout(()=>{window.scrollTo(0,p)},0)},u=t=>{let e=t.data("target");r(e)&&(t.addClass("active").siblings().removeClass("active"),$(`#${e}`).addClass("active").siblings().removeClass("active"),y({tabId:e}))},d=({tabId:t,tabEle:e}={})=>{u(t?$(`.tabs > li[data-target="${t}"]`):e||$(".tabs > li:first-child"))};d({tabId:l?.lastActiveTab}),$(".tabs > li").on("click",t=>{d({tabEle:$(t.currentTarget)})}),A(),window.addEventListener("unload",()=>{let t=$(".tabs > li.active").data("target");if(r(t)){let e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,p={lastActiveTab:t,["tab1"]:{data:n,lastFetchTime:o,lastScrollTop:t==="tab1"?e:void 0},["tab2"]:{data:a,lastFetchTime:c,lastScrollTop:t==="tab2"?e:void 0},["tab3"]:{lastScrollTop:t==="tab3"?e:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(p))}})}window.addEventListener("load",()=>{P()});
