"use strict";async function v(o,e){let i=await fetch(o,e),a=i.headers.get("X-Rate-Limit-Limit"),s=i.headers.get("X-Rate-Limit-Reset"),p=i.headers.get("X-Rate-Limit-Remaining"),d={limit:a?Number(a):void 0,reset:s?Number(s):void 0,remaining:p?Number(p):void 0};return await chrome.storage.sync.set({["legacy-api"]:d}),i.json()}function I(o){return v(`${"https://www.v2ex.com/api"}/topics/latest.json`,o)}function w(o){return v(`${"https://www.v2ex.com/api"}/topics/hot.json`,o)}function h(o){let e=new Date(o*1e3),i=e.getFullYear().toString(),a=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0");return`${i}-${a}-${s}`}function L(){chrome.storage.sync.get("api",o=>{let e=o["api"];e&&($("#pat").val(e.pat??""),$("#limit").val(e.limit??""),$("#reset").val(e.reset?h(e.reset):""),$("#remaining").val(e.remaining??""))}),chrome.storage.sync.get("legacy-api",o=>{let e=document.querySelector("#limitv1"),i=document.querySelector("#resetv1"),a=document.querySelector("#remainingv1"),s=o["legacy-api"];e instanceof HTMLInputElement&&i instanceof HTMLInputElement&&a instanceof HTMLInputElement&&s&&(e.value=String(s.limit),i.value=String(s.reset),a.value=String(s.remaining))}),$("#settings-form").on("submit",function(o){o.preventDefault();let e=$("#pat").val();typeof e=="string"&&chrome.storage.sync.set({["api"]:{pat:e}},()=>{console.log("\u4FDD\u5B58\u6210\u529F")})}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function A(){let o=t=>t.map(n=>`
          <li class="topic-item">
            <a href="${n.url}" target="_blank">
              <span class="title">${n.title}</span>
              <span class="content">${n.content}</span>
            </a>
          </li>
          `).join(""),e=()=>$(".tabs > li.active"),i=t=>typeof t=="string"&&(t==="tab1"||t==="tab2"||t==="tab3"),a={["tab1"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab2"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab3"]:{}},s=window.localStorage.getItem("v2p_popup"),p=s?JSON.parse(s):null,d=async({tabId:t})=>{let n,c=0,r=$(`#${t}`);if(t==="tab1"||t==="tab2")if(r.find(".topics").length>0)c=a[t].lastScrollTop??0;else{let S=`
        <div class="tab-loading">
          <span class="loading">
            <svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
              viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
              <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
                <animate
                  attributeName="opacity"
                  dur="1s"
                  values="0;1;0"
                  repeatCount="indefinite"
                  begin="0.1"/>    
              </circle>
              <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
                <animate
                  attributeName="opacity"
                  dur="1s"
                  values="0;1;0"
                  repeatCount="indefinite" 
                  begin="0.2"/>       
              </circle>
              <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
                <animate
                  attributeName="opacity"
                  dur="1s"
                  values="0;1;0"
                  repeatCount="indefinite" 
                  begin="0.3"/>     
              </circle>
            </svg>
          </span>
        </div>
        `,T=async()=>{r.html(S);try{if(t==="tab1"){let l=await w();return a[t].data=l,a[t].lastFetchTime=Date.now(),l}else{let l=await I();return a[t].data=l,a[t].lastFetchTime=Date.now(),l}}catch{r.html("\u65E0\u6CD5\u83B7\u53D6\u5230\u5217\u8868\u6570\u636E\u3002")}};if(p){let{data:l,lastFetchTime:f,lastScrollTop:b}=p[t];b&&(c=b),!l||!f||Date.now()-f>1e3*60*10?n=await T():n=l}else n=await T();if(n){let l=$('<ul class="topics">').append(o(n));r.empty().append(l)}}setTimeout(()=>{r.scrollTop(c)},0)},m=t=>{let n=t.data("target");if(i(n)){let c=e(),r=c.data("target");if(i(r)){let u=$(`#${r}`);a[r].lastScrollTop=u.scrollTop(),c.removeClass("active"),u.removeClass("active")}t.addClass("active"),$(`#${n}`).addClass("active"),d({tabId:n})}},g=({tabId:t,tabEle:n}={})=>{m(t?$(`.tabs > li[data-target="${t}"]`):n||$(".tabs > li:first-child"))};$(".tabs > li").on("click",t=>{g({tabEle:$(t.currentTarget)})}),L(),g({tabId:p?.lastActiveTab}),window.addEventListener("unload",()=>{let t=e().data("target");if(i(t)){let c=$(`#${t}`).scrollTop(),r={lastActiveTab:t,["tab1"]:{data:a["tab1"].data,lastFetchTime:a["tab1"].lastFetchTime,lastScrollTop:t==="tab1"?c:void 0},["tab2"]:{data:a["tab2"].data,lastFetchTime:a["tab2"].lastFetchTime,lastScrollTop:t==="tab2"?c:void 0},["tab3"]:{lastScrollTop:t==="tab3"?c:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(r))}})}window.addEventListener("load",()=>{A()});
