"use strict";var v=`
<svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
  viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
  <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite"
      begin="0.1"/>    
  </circle>
  <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.2"/>       
  </circle>
  <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.3"/>     
  </circle>
</svg>
`;async function b(i,o){let e=await fetch(i,o),n=e.headers.get("X-Rate-Limit-Limit"),c=e.headers.get("X-Rate-Limit-Reset"),s=e.headers.get("X-Rate-Limit-Remaining"),d={limit:n?Number(n):void 0,reset:c?Number(c):void 0,remaining:s?Number(s):void 0};return await chrome.storage.sync.set({["legacy-api"]:d}),e.json()}function x(i){return b(`${"https://www.v2ex.com/api"}/topics/latest.json`,i)}function I(i){return b(`${"https://www.v2ex.com/api"}/topics/hot.json`,i)}async function k(i,o){let e=await fetch(i,o),n=e.headers.get("X-Rate-Limit-Limit"),c=e.headers.get("X-Rate-Limit-Reset"),s=e.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",d=>{let u={pat:d["api"]?.pat,limit:n?Number(n):void 0,reset:c?Number(c):void 0,remaining:s?Number(s):void 0};chrome.storage.sync.set({["api"]:u})}),e.json()}function S(i,o=1){return k(`${"https://www.v2ex.com/api/v2"}/notifications?p=${o}`,{method:"GET",headers:{Authorization:`Bearer ${i}`}})}function y(i,o=!1){let e=new Date(i*1e3),n=e.getFullYear().toString(),c=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0"),d=`${n}-${c}-${s}`;if(o){let u=e.getHours().toString().padStart(2,"0"),g=e.getMinutes().toString().padStart(2,"0"),t=e.getSeconds().toString().padStart(2,"0");return`${d} ${u}:${g}:${t}`}return d}var f="-";function P(){chrome.storage.sync.get("api",i=>{let o=i["api"];o&&(o.pat&&($("#pat").addClass("has-value").val(o.pat),S(o.pat).then(e=>{console.log({notifications:e})}).catch(e=>{console.error(e)})),$("#limit").val(o.limit??f),$("#reset").val(o.reset?y(o.reset,!0):f),$("#remaining").val(o.remaining??f))}),$("#settings-form").on("submit",function(i){i.preventDefault();let o=$("#pat").val();typeof o=="string"&&chrome.storage.sync.set({["api"]:{pat:o}},()=>{console.log("\u4FDD\u5B58\u6210\u529F")})}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function C(){let i=t=>t.map(a=>`
          <li class="topic-item">
            <a href="${a.url}" target="_blank">
              <span class="title">${a.title}</span>
              <span class="content">${a.content.replace(/<[^>]*>/g,"")}</span>
            </a>
          </li>
          `).join(""),o=()=>$(".tabs > li.active"),e=t=>typeof t=="string"&&(t==="tab1"||t==="tab2"||t==="tab3"),n={["tab1"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab2"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab3"]:{}},c=window.localStorage.getItem("v2p_popup"),s=c?JSON.parse(c):null,d=async({tabId:t})=>{let a,l=0,r=$(`#${t}`);if(t==="tab1"||t==="tab2")if(r.find(".topics").length>0)l=n[t].lastScrollTop??0;else{let A=`
        <div class="tab-loading">
          <span class="loading">
            ${v}
          </span>
        </div>
        `,h=async()=>{r.html(A);try{if(t==="tab1"){let p=await I();return n[t].data=p,n[t].lastFetchTime=Date.now(),p}else{let p=await x();return n[t].data=p,n[t].lastFetchTime=Date.now(),p}}catch{r.html("\u65E0\u6CD5\u83B7\u53D6\u5230\u5217\u8868\u6570\u636E\u3002")}};if(s){let{data:p,lastFetchTime:w,lastScrollTop:T}=s[t];T&&(l=T),!p||!w||Date.now()-w>1e3*60*10?a=await h():a=p}else a=await h();if(a){let p=$('<ul class="topics">').append(i(a));r.empty().append(p)}}setTimeout(()=>{r.scrollTop(l)},0)},u=t=>{let a=t.data("target");if(e(a)){let l=o(),r=l.data("target");if(e(r)){let m=$(`#${r}`);n[r].lastScrollTop=m.scrollTop(),l.removeClass("active"),m.removeClass("active")}t.addClass("active"),$(`#${a}`).addClass("active"),d({tabId:a})}},g=({tabId:t,tabEle:a}={})=>{u(t?$(`.tabs > li[data-target="${t}"]`):a||$(".tabs > li:first-child"))};$(".tabs > li").on("click",t=>{g({tabEle:$(t.currentTarget)})}),P(),g({tabId:s?.lastActiveTab}),window.addEventListener("unload",()=>{let t=o().data("target");if(e(t)){let l=$(`#${t}`).scrollTop(),r={lastActiveTab:t,["tab1"]:{data:n["tab1"].data,lastFetchTime:n["tab1"].lastFetchTime,lastScrollTop:t==="tab1"?l:void 0},["tab2"]:{data:n["tab2"].data,lastFetchTime:n["tab2"].lastFetchTime,lastScrollTop:t==="tab2"?l:void 0},["tab3"]:{lastScrollTop:t==="tab3"?l:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(r))}})}window.addEventListener("load",()=>{C()});
