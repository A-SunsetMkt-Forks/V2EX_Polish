"use strict";async function b(o,c){let e=await fetch(o,c),a=e.headers.get("X-Rate-Limit-Limit"),i=e.headers.get("X-Rate-Limit-Reset"),r=e.headers.get("X-Rate-Limit-Remaining"),s={limit:a?Number(a):void 0,reset:i?Number(i):void 0,remaining:r?Number(r):void 0};return await chrome.storage.sync.set({["legacy-api"]:s}),e.json()}function w(o){return b(`${"https://www.v2ex.com/api"}/topics/latest.json`,o)}function y(o){return b(`${"https://www.v2ex.com/api"}/topics/hot.json`,o)}function S(o){let c=new Date(o*1e3),e=c.getFullYear().toString(),a=(c.getMonth()+1).toString().padStart(2,"0"),i=c.getDate().toString().padStart(2,"0");return`${e}-${a}-${i}`}function x(){let o=document.querySelector("#save");chrome.storage.sync.get("api",e=>{let a=document.querySelector("#pat"),i=document.querySelector("#limit"),r=document.querySelector("#reset"),s=document.querySelector("#remaining"),l=e["api"];a instanceof HTMLInputElement&&i instanceof HTMLInputElement&&r instanceof HTMLInputElement&&s instanceof HTMLInputElement&&l&&(a.value=l.pat??"",i.value=String(l.limit),r.value=l.reset?S(l.reset):"",s.value=String(l.remaining))}),chrome.storage.sync.get("legacy-api",e=>{let a=document.querySelector("#limitv1"),i=document.querySelector("#resetv1"),r=document.querySelector("#remainingv1"),s=e["legacy-api"];a instanceof HTMLInputElement&&i instanceof HTMLInputElement&&r instanceof HTMLInputElement&&s&&(a.value=String(s.limit),i.value=String(s.reset),r.value=String(s.remaining))});async function c(){let e=document.querySelector("#pat");if(e instanceof HTMLInputElement&&e.value.length>0){let a={pat:e.value};await chrome.storage.sync.set({["api"]:a})}}o instanceof HTMLButtonElement&&o.addEventListener("click",()=>{c()}),$("#clear-storage").on("click",()=>{window.localStorage.clear()})}function D(){let o=t=>t.map(n=>`
          <li class="topic-item">
            <a href="${n.url}" target="_blank">
              <span class="title">${n.title}</span>
              <span class="content">${n.content}</span>
            </a>
          </li>
          `).join(""),c=()=>$(".tabs > li.active"),e=t=>typeof t=="string"&&(t==="tab1"||t==="tab2"||t==="tab3"),a,i,r,s,l=window.localStorage.getItem("v2p_popup"),d=l?JSON.parse(l):null,L=async({tabId:t})=>{let n=[],p=0,u=$(`#${t}`);if(t==="tab1"||t==="tab2"){let h=`
      <div class="tab-loading">
        <span class="loading">
          <svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
            viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
            <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
              <animate
                attributeName="opacity"
                dur="1s"
                values="0;1;0"
                repeatCount="indefinite"
                begin="0.1"/>    
            </circle>
            <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
              <animate
                attributeName="opacity"
                dur="1s"
                values="0;1;0"
                repeatCount="indefinite" 
                begin="0.2"/>       
            </circle>
            <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
              <animate
                attributeName="opacity"
                dur="1s"
                values="0;1;0"
                repeatCount="indefinite" 
                begin="0.3"/>     
            </circle>
          </svg>
        </span>
      </div>
      `,T=async()=>{if(u.html(h),t==="tab1"){let m=await y();return a=m,r=Date.now(),m}else if(t==="tab2"){let m=await w();return i=m,s=Date.now(),m}return[]};if(d){let{data:m,lastFetchTime:I,lastScrollTop:v}=d[t];v&&(p=v),!m||!I||Date.now()-I>1e3*60*10?n=await T():n=m}else n=await T();let A=$('<ul class="topics">').append(o(n));u.empty().append(A)}setTimeout(()=>{u.scrollTop(p)},0)},g=t=>{let n=t.data("target");if(e(n)){let p=c(),u=p.data("target");e(u)&&(p.removeClass("active"),$(`#${u}`).removeClass("active")),t.addClass("active"),$(`#${n}`).addClass("active"),L({tabId:n})}},f=({tabId:t,tabEle:n}={})=>{g(t?$(`.tabs > li[data-target="${t}"]`):n||$(".tabs > li:first-child"))};f({tabId:d?.lastActiveTab}),$(".tabs > li").on("click",t=>{f({tabEle:$(t.currentTarget)})}),x(),window.addEventListener("unload",()=>{let t=c().data("target");if(e(t)){let p=$(`#${t}`).scrollTop(),u={lastActiveTab:t,["tab1"]:{data:a,lastFetchTime:r,lastScrollTop:t==="tab1"?p:void 0},["tab2"]:{data:i,lastFetchTime:s,lastScrollTop:t==="tab2"?p:void 0},["tab3"]:{lastScrollTop:t==="tab3"?p:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(u))}})}window.addEventListener("load",()=>{D()});
