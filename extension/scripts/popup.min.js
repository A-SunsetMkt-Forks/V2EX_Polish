"use strict";var T=60*60*1e3;var q=$('#Top .tools > a[href^="/member"]').text(),G=$('#Main > .box > .header > small > a[href^="/member"]').text(),X=$("#Main #Tabs ~ .cell.item"),V=$("#Main .box:has(.topic_content)"),R=$('#Main .box:has(.cell[id^="r_"])'),b=R.find('.cell[id^="r_"]'),z=b.find("> table > tbody > tr"),U=z.map((e,n)=>{let t=b[e].id,a=$(n).find("> td:nth-child(3)"),c=a.find("> strong > a"),d=c.text(),p=c.prop("href"),o=a.find("> .reply_content").text(),s=Number(a.find("span.small").text()),l=a.find("span.no").text(),i=Array.from(o.matchAll(/@([a-zA-Z0-9]+)/g)),f=i.length>0?i.map(([,u])=>u):void 0,g=Array.from(o.matchAll(/#(\d+)/g)),r=g.length>0?g.map(([,u])=>u):void 0;return{id:t,memberName:d,memberLink:p,content:o,likes:s,floor:l,index:e,refMemberNames:f,refFloors:r}}).get();function k(e){let{children:n,className:t="",type:a="button"}=e;return $(`<button class="normal button ${t}" type="${a}">${n}</button>`)}var S=`
<svg version="1.1" id="L4" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
  viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
  <circle fill="currentcolor" stroke="none" cx="6" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite"
      begin="0.1"/>    
  </circle>
  <circle fill="currentcolor" stroke="none" cx="26" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.2"/>       
  </circle>
  <circle fill="currentcolor" stroke="none" cx="46" cy="50" r="6">
    <animate
      attributeName="opacity"
      dur="1s"
      values="0;1;0"
      repeatCount="indefinite" 
      begin="0.3"/>     
  </circle>
</svg>
`;async function L(e,n){let t=await fetch(e,n),a=t.headers.get("X-Rate-Limit-Limit"),c=t.headers.get("X-Rate-Limit-Reset"),d=t.headers.get("X-Rate-Limit-Remaining"),p={limit:a?Number(a):void 0,reset:c?Number(c):void 0,remaining:d?Number(d):void 0};return await chrome.storage.sync.set({["legacy-api"]:p}),t.json()}function A(e){return L(`${"https://www.v2ex.com/api"}/topics/latest.json`,e)}function M(e){return L(`${"https://www.v2ex.com/api"}/topics/hot.json`,e)}async function F(e,n){let t=await fetch(e,n),a=t.headers.get("X-Rate-Limit-Limit"),c=t.headers.get("X-Rate-Limit-Reset"),d=t.headers.get("X-Rate-Limit-Remaining");return chrome.storage.sync.get("api",p=>{let o={pat:p["api"]?.pat,limit:a?Number(a):void 0,reset:c?Number(c):void 0,remaining:d?Number(d):void 0};chrome.storage.sync.set({["api"]:o})}),t.json()}function C(e,n=1){return F(`${"https://www.v2ex.com/api/v2"}/notifications?p=${n}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}})}function I(e,n=!1){let t=new Date(e*1e3),a=t.getFullYear().toString(),c=(t.getMonth()+1).toString().padStart(2,"0"),d=t.getDate().toString().padStart(2,"0"),p=`${a}-${c}-${d}`;if(n){let o=t.getHours().toString().padStart(2,"0"),s=t.getMinutes().toString().padStart(2,"0"),l=t.getSeconds().toString().padStart(2,"0");return`${p} ${o}:${s}:${l}`}return p}function w(e){return typeof e=="string"&&(e==="tab-hot"||e==="tab-latest"||e==="tab-message"||e==="tab-setting")}function P(){let e=0;for(let n=0;n<window.localStorage.length;n++){let t=window.localStorage.key(n);if(t){let a=window.localStorage.getItem(t);a&&(e+=t.length+a.length)}}return e}function D(e){let n=["bytes","KB","MB","GB","TB"],t=0;for(;e>=1024&&t<4;)e/=1024,t++;return e.toFixed(2)+" "+n[t]}function N(e){return e.replace(/[<>&"'']/g,n=>{switch(n){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";default:return n}})}var x="-";var H=`
<div class="tab-loading">
  <span class="loading">
    ${S}
  </span>
</div>
`,E='<div class="fetch-error">\u65E0\u6CD5\u83B7\u53D6\u5230\u5217\u8868\u6570\u636E\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002</div>',m={["tab-hot"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab-latest"]:{data:void 0,lastFetchTime:void 0,lastScrollTop:void 0},["tab-message"]:{data:void 0,lastFetchTime:void 0},["tab-setting"]:{}};function J(){let e=$("#pat");e.on("change",n=>{n.target.value?e.addClass("has-value"):e.removeClass("has-value")}),chrome.storage.sync.get("api",n=>{let t=n["api"];t&&(t.pat&&e.val(t.pat).addClass("has-value"),$("#limit").val(t.limit??x),$("#reset").val(t.reset?I(t.reset,!0):x),$("#remaining").val(t.remaining??x))}),$("#settings-form").on("submit",n=>{n.preventDefault();let t=e.val();typeof t=="string"&&chrome.storage.sync.set({["api"]:{pat:t}},()=>{let a=$(".submit-btn"),c=a.text();a.text("\u4FDD\u5B58\u6210\u529F").prop("disabled",!0),setTimeout(()=>{a.text(c).prop("disabled",!1)},1500)})});{let n=()=>{let t=P(),a=D(t);$(".storage-size").text(a)};n(),$("#clear-storage").on("click",()=>{m["tab-hot"].data=void 0,m["tab-latest"].data=void 0,window.localStorage.clear(),n()})}}function O(){let e=o=>o.map(s=>`
          <li class="topic-item">
            <a href="${s.url}" target="_blank">
              <span class="title">${N(s.title)}</span>
              <span class="content">${s.content.replace(/<[^>]*>/g,"")}</span>
            </a>
          </li>
          `).join(""),n=()=>$(".tabs > li.active"),t=window.localStorage.getItem("v2p_popup"),a=t?JSON.parse(t):null,c=async({tabId:o})=>{let s,l=0,i=$(`#${o}`);if(o==="tab-hot"||o==="tab-latest")if(i.find(".list").length>0)l=m[o].lastScrollTop??0;else{let g=async()=>{i.html(H);try{if(o==="tab-hot"){let r=await M();return m[o].data=r,m[o].lastFetchTime=Date.now(),r}else{let r=await A();return m[o].data=r,m[o].lastFetchTime=Date.now(),r}}catch{i.html(E)}};if(a){let{data:r,lastFetchTime:u,lastScrollTop:h}=a[o];h&&(l=h),!r||!u||Date.now()-u>T?s=await g():s=r}else s=await g();if(s){let r=$('<ul class="list">').append(e(s));i.empty().append(r)}}o==="tab-message"&&chrome.storage.sync.get("api",f=>{let g=f["api"];if(g?.pat){if(i.find(".list").length>0)return;i.html(H),C(g.pat).then(({result:u})=>{if(u.length>0){let h=$('<ul class="list">').append(u.map(v=>`
                    <li class="notice-item">
                      <div class="notice">
                        ${v.text}
                      </div>
                      ${v.payload?`<div class="payload">${v.payload}</div>`:""}
                    </li>
                    `).join(""));h.find(".notice-item .notice > a").each((v,B)=>{let y=$(B);y.prop("target","_blank").prop("href",`${"https://www.v2ex.com"}${y.attr("href")??""}`)}),i.empty().append(`
                  <div class="message-actions">
                    <a class="view-all-btn" href="${"https://www.v2ex.com"}/notifications" target="_blank">\u67E5\u770B\u6240\u6709\u6D88\u606F</a>
                  </div>
                  `).append(h)}else i.empty().append('<div class="tip">\u65E0\u4EFB\u4F55\u6D88\u606F</div>')}).catch(()=>{i.html(E)})}else{let r=k({children:"\u53BB\u8BBE\u7F6E"}).on("click",()=>{p({tabId:"tab-setting"})}),u=$('<div class="tip"><p>\u9700\u6C42\u8BBE\u7F6E\u60A8\u7684\u4E2A\u4EBA\u8BBF\u95EE\u4EE4\u724C\uFF08PAT\uFF09\u540E\u624D\u80FD\u8BF7\u6C42\u83B7\u53D6\u6D88\u606F\u6570\u636E</p></div>').append(r);i.empty().append(u)}}),setTimeout(()=>{i.scrollTop(l)},0)},d=o=>{let s=o.data("target");if(w(s)){let l=n(),i=l.data("target");if(w(i)){let f=$(`#${i}`);m[i].lastScrollTop=f.scrollTop(),l.removeClass("active"),f.removeClass("active")}o.addClass("active"),$(`#${s}`).addClass("active"),c({tabId:s})}},p=({tabId:o,tabEle:s}={})=>{d(o?$(`.tabs > li[data-target="${o}"]`):s||$(".tabs > li:first-child"))};$(".tabs > li").on("click",o=>{p({tabEle:$(o.currentTarget)})}),J(),p({tabId:a?.lastActiveTab}),window.addEventListener("unload",()=>{let o=n().data("target");if(w(o)){let l=$(`#${o}`).scrollTop(),i={lastActiveTab:o,["tab-hot"]:{data:m["tab-hot"].data,lastFetchTime:m["tab-hot"].lastFetchTime,lastScrollTop:o==="tab-hot"?l:void 0},["tab-latest"]:{data:m["tab-latest"].data,lastFetchTime:m["tab-latest"].lastFetchTime,lastScrollTop:o==="tab-latest"?l:void 0},["tab-setting"]:{lastScrollTop:o==="tab-setting"?l:void 0}};window.localStorage.setItem("v2p_popup",JSON.stringify(i))}})}window.addEventListener("load",()=>{O()});
